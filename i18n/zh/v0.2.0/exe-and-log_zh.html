<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-i18n/zh/v0.2.0/exe-and-log_zh" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">Kosmos 中的 EXEC 和 Log 设计 | Kosmos</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://duanmengkk.github.io&#x27;/website/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://duanmengkk.github.io&#x27;/website/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://duanmengkk.github.io&#x27;/website/i18n/zh/v0.2.0/exe-and-log_zh"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Kosmos 中的 EXEC 和 Log 设计 | Kosmos"><meta data-rh="true" name="description" content="Kosmos 的 EXEC 和 Log 解决方案"><meta data-rh="true" property="og:description" content="Kosmos 的 EXEC 和 Log 解决方案"><link data-rh="true" rel="icon" href="/website/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://duanmengkk.github.io&#x27;/website/i18n/zh/v0.2.0/exe-and-log_zh"><link data-rh="true" rel="alternate" href="https://duanmengkk.github.io&#x27;/website/i18n/zh/v0.2.0/exe-and-log_zh" hreflang="en"><link data-rh="true" rel="alternate" href="https://duanmengkk.github.io&#x27;/website/i18n/zh/v0.2.0/exe-and-log_zh" hreflang="x-default"><link rel="stylesheet" href="/website/assets/css/styles.f49b5b88.css">
<script src="/website/assets/js/runtime~main.3416bce9.js" defer="defer"></script>
<script src="/website/assets/js/main.dace5895.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/website/"><div class="navbar__logo"><img src="/website/img/logo.svg" alt="Kosmos Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/website/img/logo.svg" alt="Kosmos Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Kosmos</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/website/v0.2.0/getting-started/introduction">Documentation</a><a href="https://kosmos-io.github.io/website/v0.2.0/quick-start" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Examples<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/kosmos-io/kosmos" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><main class="docMainContainer_TBSr docMainContainerEnhanced_lQrH"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Kosmos 中的 EXEC 和 Log 设计</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="kosmos-的-exec-和-log-解决方案">Kosmos 的 EXEC 和 Log 解决方案<a href="#kosmos-的-exec-和-log-解决方案" class="hash-link" aria-label="Direct link to Kosmos 的 EXEC 和 Log 解决方案" title="Direct link to Kosmos 的 EXEC 和 Log 解决方案">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="简介">简介<a href="#简介" class="hash-link" aria-label="Direct link to 简介" title="Direct link to 简介">​</a></h3>
<p>在 Kosmos 中，调度到 kosmos-node 的 pod 也支持 <code>kubectl exec</code> 和 <code>kubectl log</code> 功能。
由于 <code>kubectl exec</code> 和 <code>kubectl log</code> 的整体架构是相同的，我们将使用 <code>kubectl exec</code> 作为示例来介绍整体架构。
下图展示了整体设计架构。</p>
<p><img decoding="async" loading="lazy" alt="EXE Log_Arch.png" src="/website/assets/images/EXEC_Log_Arch-55169f06d1b0071b36b0ddb300a3e3fd.png" width="1110" height="863" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="背景知识">背景知识<a href="#背景知识" class="hash-link" aria-label="Direct link to 背景知识" title="Direct link to 背景知识">​</a></h3>
<p>首先，让我们探讨在 Kubernetes 中如何实现 <code>kubectl exec</code>。
架构图中的 <em><strong>leaf-cluster</strong></em> 部分是原生集群的 <code>kubectl exec</code> 功能的代表。
用户发起的 kubectl exec 请求由 apiserver 处理。
apiserver 在接收到 exec 请求后，需要将请求转发到 pod 所在的节点，因此需要查询分配了 pod 的节点信息。
在 Kubernetes 源代码中，apiserver 会调用 <code>ExecLocation</code> 方法以获取 pod 的 exec url。
代码如下：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ExecLocation 返回 pod 容器的 exec URL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 如果 opts.Container 为空且 pod 中只有一个容器, 则使用该容器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func ExecLocation(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx context.Context,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    getter ResourceGetter,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    connInfo client.ConnectionInfoGetter,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name string,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    opts *api.PodExecOptions,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) (*url.URL, http.RoundTripper, error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return streamLocation(ctx, getter, connInfo, name, opts, opts.Container, &quot;exec&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>ExecLocation</code> 调用了 <code>streamLocation</code> 方法，streamLocation 通过 pod 名称获取 pod 信息。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func streamLocation(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx context.Context,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    getter ResourceGetter,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    connInfo client.ConnectionInfoGetter,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name string,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    opts runtime.Object,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    container,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    path string,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) (*url.URL, http.RoundTripper, error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pod, err := getPod(ctx, getter, name)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return nil, nil, err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 尝试确定一个容器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 如果提供了一个容器, 则它必须是有效的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    container, err = validateContainer(container, pod)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return nil, nil, err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nodeName := types.NodeName(pod.Spec.NodeName)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if len(nodeName) == 0 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 如果 pod 尚未分配主机, 则返回空位置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return nil, nil, errors.NewBadRequest(fmt.Sprintf(&quot;pod %s 尚未分配主机&quot;, name))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nodeInfo, err := connInfo.GetConnectionInfo(ctx, nodeName)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return nil, nil, err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params := url.Values{}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if err := streamParams(params, opts); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return nil, nil, err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    loc := &amp;url.URL{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Scheme:   nodeInfo.Scheme,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Host:     net.JoinHostPort(nodeInfo.Hostname, nodeInfo.Port),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Path:     fmt.Sprintf(&quot;/%s/%s/%s/%s&quot;, path, pod.Namespace, pod.Name, container),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RawQuery: params.Encode(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return loc, nodeInfo.Transport, nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后通过 <code>pod.Spec.NodeName</code> 获取分配 pod 的节点名称，再调用一个关键方法 <code>GetConnectionInfo</code>。
代码如下：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// GetConnectionInfo 从 Node API 对象的状态中检索连接信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (k *NodeConnectionInfoGetter) GetConnectionInfo(ctx context.Context, nodeName types.NodeName) (*ConnectionInfo, error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    node, err := k.nodes.Get(ctx, string(nodeName), metav1.GetOptions{})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return nil, err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 查找 kubelet 报告的地址, 使用首选地址类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    host, err := nodeutil.GetPreferredNodeAddress(node, k.preferredAddressTypes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return nil, err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 使用 kubelet 报告的端口, 如果存在</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    port := int(node.Status.DaemonEndpoints.KubeletEndpoint.Port)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if port &lt;= 0 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        port = k.defaultPort</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return &amp;ConnectionInfo{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Scheme:                         k.scheme,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Hostname:                       host,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Port:                           strconv.Itoa(port),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Transport:                      k.transport,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        InsecureSkipTLSVerifyTransport: k.insecureSkipTLSVerifyTransport,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }, nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>GetConnectionInfo</code> 通过节点名称获取节点信息，然后使用 <code>GetPreferredNodeAddress</code> 选择一个合适的主机，通过 <code>streamLocation</code> 处理后，拼接一个 exec 请求 URL。
apiserver 将知道应将 exec 请求转发到哪个节点。
运行在节点上的 kubelet 服务将捕获 exec 请求，然后与 pod 建立链接。</p>
<p>以上简要介绍了建立 kubectl exec 的过程。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="在-kosmos-中的实现">在 Kosmos 中的实现<a href="#在-kosmos-中的实现" class="hash-link" aria-label="Direct link to 在 Kosmos 中的实现" title="Direct link to 在 Kosmos 中的实现">​</a></h3>
<p>接下来，让我们看看整体架构图中的 <em><strong>root-cluster</strong></em>。
为了将 exec 请求传递到 leaf 集群，需要对 exec 请求进行转发。</p>
<p>首先，我们需要告诉 apiserver，kosmos-node 的 IP 地址是 <em><strong>clustertree-cluster-manager</strong></em> 的 podIP，这将导致 apiserver 将 exec 请求转发到 <em><strong>clustertree-cluster-manager</strong></em>。
当我们同步 kosmos-node 的节点信息时，我们从环境变量 <code>LEAF_NODE_IP</code> 中读取该信息。
启动 <em><strong>clustertree-cluster-manager</strong></em> 服务时配置了此环境变量。
关键配置片段如下：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   serviceAccountName: clustertree</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - name: clustertree-cluster-manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       image: ghcr.io/kosmos-io/clustertree-cluster-manager:__VERSION__</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       imagePullPolicy: IfNotPresent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         - name: APISERVER_CERT_LOCATION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           value: /etc/cluster-tree/cert/cert.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         - name: APISERVER_KEY_LOCATION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           value: /etc/cluster-tree/cert/key.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         - name: LEAF_NODE_IP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           valueFrom:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             fieldRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               fieldPath: status.podIP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         - name: PREFERRED-ADDRESS-TYPE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           value: InternalDNS</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后我们需要启动一个类似于 kubelet 的服务来监听 exec。
在 <em><strong>clustertree-cluster-manager</strong></em> 服务中，我们启动了一个 nodeserver 服务。
代码片段如下：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nodeServer := nodeserver.NodeServer{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RootClient:        mgr.GetClient(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GlobalLeafManager: globalleafManager,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">go func() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if err := nodeServer.Start(ctx, opts); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        klog.Errorf(&quot;failed to start node server: %v&quot;, err)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>此服务监视 exec 和 log 请求，并将监视到的请求代理转发到相应的 leaf 集群。
源代码如下：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func (s *NodeServer) AttachRoutes(m *http.ServeMux) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    r := mux.NewRouter()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    r.StrictSlash(true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    r.HandleFunc(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;/containerLogs/{namespace}/{pod}/{container}&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        api.ContainerLogsHandler(s.getClient),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ).Methods(&quot;GET&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    r.HandleFunc(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;/exec/{namespace}/{pod}/{container}&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        api.ContainerExecHandler(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            api.ContainerExecOptions{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                StreamIdleTimeout:     30 * time.Second,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                StreamCreationTimeout: 30 * time.Second,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            s.getClient,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ).Methods(&quot;POST&quot;, &quot;GET&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    r.NotFoundHandler = http.HandlerFunc(api.NotFound)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    m.Handle(&quot;/&quot;, r)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>完成转发部分后，我们需要让根集群中的 API server 识别 kosmos-node 的通信地址为 <em><strong>clustertree-cluster-manager</strong></em> 服务的地址。
因此，在维护 kosmos-node 的状态时，我们将 <em><strong>clustertree-cluster-manager</strong></em> 的 podIP 同步到 kosmos-node。
完整的过程如下：</p>
<ul>
<li>用户发起 exec 请求。</li>
<li>根集群中的 API server 接收到 exec 请求，并根据 pod 信息查询节点信息。</li>
<li>查询到的节点主机是 <em><strong>clustertree-cluster-manager</strong></em> 的 podIP。</li>
<li>根集群中的 API server 与 <em><strong>clustertree-cluster-manager</strong></em> 建立 exec 连接。</li>
<li><em><strong>clustertree-cluster-manager</strong></em> 接收到 exec 连接请求，查询 pod 信息，并将 exec 请求代理到 leaf 集群。
通过这个过程，Kosmos 实现了 exec 功能，log 功能的工作方式也是相同的。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="定制化">定制化<a href="#定制化" class="hash-link" aria-label="Direct link to 定制化" title="Direct link to 定制化">​</a></h3>
<p>在与 es 产品对接时，有一个定制化需求。
上述设计将导致所有 kosmos-node 的 IP 都是 <em><strong>clustertree-cluster-manager</strong></em> 的 podIP。
在 es 的产品设计中，nodeIP 用作主键，这会导致产品无法存储到仓库中。为此，kosmos 进行了特殊设计。
在通过 kubectl get node -owide 获取的节点信息中，ip 地址属于 InternalIP 类型。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo kubectl get nodes -owide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                STATUS   ROLES                          AGE     VERSION     INTERNAL-IP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     EXTERNAL-IP   OS-IMAGE                                        KERNEL-VERSION                                CONTAINER-RUNTIME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kosmos-control-1    Ready    control-plane,master,node      65d     v1.21.5     192.xx.xx.1     &lt;none&gt;        BigCloud Enterprise Linux For Euler 21.10 LTS   4.19.90-2107.6.0.0192.8.oe1.bclinux.x86_64    containerd://1.5.7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kosmos-control-2    Ready    node                           65d     v1.21.5     192.xx.xx.2     &lt;none&gt;        BigCloud Enterprise Linux For Euler 21.10 LTS   4.19.90-2107.6.0.0192.8.oe1.bclinux.x86_64    containerd://1.5.7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kosmos-cluster1     Ready    agent                          20d     v1.21.5     192.xx.xx.3     &lt;none&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在查询节点主机时，上文提到的 GetPreferredNodeAddress 函数将根据优先级从 Address 列表中选择一个，因此在 es 中，我们将 <em><strong>clustertree-cluster-manager</strong></em> 的 podIP 设置为比 InternalIP 类别地址更高的优先级，如下所示，可以指定 ip 的类型和值。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func GetAddress(ctx context.Context, rootClient kubernetes.Interface, originAddress []corev1.NodeAddress) ([]corev1.NodeAddress, error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    preferredAddressType := corev1.NodeAddressType(os.Getenv(&quot;PREFERRED-ADDRESS-TYPE&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if len(preferredAddressType) == 0 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        preferredAddressType = corev1.NodeInternalDNS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    prefixAddress := []corev1.NodeAddress{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {Type: preferredAddressType, Address: os.Getenv(&quot;LEAF_NODE_IP&quot;)},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    address, err := SortAddress(ctx, rootClient, originAddress)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return nil, err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return append(prefixAddress, address...), nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如何查看地址优先级？通过查看 api-server 的启动参数 - kubelet-preferred-address-types，此处设置了 GetPreferredNodeAddress 函数以获取主机的优先级。
默认情况下，InternalDNS 具有最高优先级。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">- --kubelet-preferred-address-types=InternalDNS,InternalIP,Hostname,ExternaLDNS,ExternalIP</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="结论">结论<a href="#结论" class="hash-link" aria-label="Direct link to 结论" title="Direct link to 结论">​</a></h3>
<p>在 Kosmos 中，<code>kubectl exec</code> 和 <code>kubectl log</code> 都通过 API server 被“欺骗”并重定向到我们自己的 <em><strong>clustertree-cluster-manager</strong></em> 服务。
这使得我们可以在后续步骤中实现定制化功能。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/i18n/zh/v0.2.0/design-of-exec-and-log_zh.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#kosmos-的-exec-和-log-解决方案" class="table-of-contents__link toc-highlight">Kosmos 的 EXEC 和 Log 解决方案</a><ul><li><a href="#简介" class="table-of-contents__link toc-highlight">简介</a></li><li><a href="#背景知识" class="table-of-contents__link toc-highlight">背景知识</a></li><li><a href="#在-kosmos-中的实现" class="table-of-contents__link toc-highlight">在 Kosmos 中的实现</a></li><li><a href="#定制化" class="table-of-contents__link toc-highlight">定制化</a></li><li><a href="#结论" class="table-of-contents__link toc-highlight">结论</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/website/v0.2.0/getting-started/introduction">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/website/v0.2.0/tutorials/mcs-discovery">Tutorials</a></li><li class="footer__item"><a class="footer__link-item" href="/website/v0.2.0/proposals/k8s-in-k8s">Proposals</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/kosmos-io/kosmos" target="_blank" rel="noopener noreferrer" class="footer__link-item">Community Address Name<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/kosmos-io/kosmos" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
</body>
</html>